<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>family friendly title</title>
    <link rel="stylesheet" type="text/css" href="mainpage.css">
    <link rel="icon" type="image/x-icon" href="/images/Favicon.png">
    <style>

      #coasterA {
        background-color: goldenrod;
        width: 50%;
        float: left;
        height: 100vh;
        position: relative;
      }

      #coasterB {
        background-color: coral;
        width: 50%;
        float: right;
        height: 100vh;
        position: relative;
      }
    
      #coasterInfoA,
      #coasterInfoB { /* Applied to the stats text */
        font-family: Tahoma,Verdana,Segoe,sans-serif; 
        font-size: 20px;
        color: white;
        background-color: rgba(0, 0, 0, 0.5);
        text-align: center;
        height: 100%;
        z-index: 4;
      }
    
      .credit {
        font-family: Tahoma,Verdana,Segoe,sans-serif; 
        position: fixed;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 5px;
        font-size: 12px;
        z-index: 4;
      }

      #imageCreditA {
        right: 0;
      }

      #imageCreditB { 
        left: 0;
      }

      .buttonPosition {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        display: flex;
        flex-direction: column;
        line-height: 150%;
      }

      .buttonPositionA {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        display: flex;
        flex-direction: column;
        line-height: 150%;
      }

      #lowerButton,
      #higherButton { /* Applied to the buttons */
        font-family: Tahoma,Verdana,Segoe,sans-serif; 
        font-size: 24px;
        padding: 15px 45px 15px 40px;
        cursor: pointer;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: 3px solid white;
        border-radius: 15px;
        transition-duration: 0.2s;
      }

      #higherButton {
        margin-bottom: 25px;
      }

      #lowerButton:hover {
        background-color: white;
        color: black;
      }

      #higherButton:hover {
        background-color: white;
        color: black;
      }
    
      #randomCoasterButton:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      #randomStatDisplay,
      #randomStatDisplayA {
        font-family: Tahoma,Verdana,Segoe,sans-serif; 
        font-size: 40px;
        color: white;
        text-align: center;
      }

      #randomStatDeco {
        font-family: Tahoma,Verdana,Segoe,sans-serif; 
        font-size: 30px;
        color: white;
        text-align: center;
      }

      #leftStat {
        font-family: Tahoma,Verdana,Segoe,sans-serif; 
        font-size: 50px;
        color: rgb(241, 241, 103);
        text-align: center;
        margin: 0px;
        margin-bottom: 25px;
      }

      #leftUnit {
        font-family: Tahoma,Verdana,Segoe,sans-serif; 
        font-size: 30px;
        color: white;
        text-align: center;
        margin: 0;
      }

      #randomNameDeco {
        font-family: Tahoma,Verdana,Segoe,sans-serif; 
        font-size: 26px;
        color: white;
        text-align: center;
      }

      #settingsPanel {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 10px;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  

<body style="margin: 0">
  <div id="coasterContainer">
    <!-- Coaster A section -->
    <div id="coasterA">
      <div id="coasterInfoA"></div>
      <!-- <div id="coasterStatsA"></div> -->

      <!-- Stat Left Comparison -->
      <div class="buttonPositionA">
        <div id="randomStatDisplayA"></div>
        <div id="statValA"></div>
        <div id="unitValA"></div>
      </div>

      <div id="imageCreditA" class="credit"></div>
    </div>

    <!-- Coaster B section -->
    <div id="coasterB">
      <div id="coasterInfoB"></div>
      <!-- <div id="coasterStatsB"></div> -->

      <!-- Buttons! Buttons! -->
      <div class="buttonPosition">
        <div id="randomStatDisplay"></div>
        <button id="higherButton" onclick="higherInput()">Higher</button>
        <button id="lowerButton" onclick="lowerInput()">Lower</button>
        <div id="randomNameDisplay"></div>
      </div>

      <div id="imageCreditB" class="credit"></div>
    </div>
  </div>

  <div id="settingsPanel">
    <p>Settings content !...</p>
    <button onclick="closeSettingsPanel()">Close</button>
  </div>


  <button id="settingsButton" onclick="toggleSettingsPanel()">Settings</button>
  <button id="randomCoasterButton" class="dev" onclick="getRandomCoasters()">Get Random Coasters</button>

  <script>
    let lengthValue, heightValue, dropValue, speedValue, angleValue, capacityValue, durationValue, yearValue, invertValue, costValue; // scope
    let isFirstPress = true; // basically is it the first round, do we need to start the game with 2 coasters or port over?
    let coasterA, coasterB; // scope
    let coasterStats = []; // all coaster stats ig
    let repeatLen = 5; // number of coasters to cycle before repeats are allowed
  
    whitelist = [1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40];
    let previousCoasters = [];
    let answer = 'tempN/A';
    let statType = "i"; // imperial by default complain louder I care so much
  
    async function getRandomCoasters() {
      // Disable the button NO SPAM SO SAD >:(
      document.getElementById('randomCoasterButton').disabled = true;
      let dataA, dataB;
  
      // Check if very first round
      // Check if it's the first press or if the coasters are the same
      if (isFirstPress || (coasterA && coasterB && coasterA.id === coasterB.id)) {
        // Fetch data for Coaster A
        dataA = await fetchRandomCoaster('A');
        displayCoasterInfo('A', dataA);
        coasterStats['A'] = getCoasterStats(dataA);
        coasterStats['A'] = { ...getCoasterStats(dataA), name: dataA.name, id: dataA.id }; // Set name for coaster A
        previousCoasters.push(coasterStats['A'].id); // Only set A on the very first round, after it is all B being set for the previous coaster array

        // Fetch data for Coaster B
        do {
          dataB = await fetchRandomCoaster('B');
        } while (isCoasterInPreviousCoasters(dataB)); // Keep fetching until Coaster B is different from Coaster A

        displayCoasterInfo('B', dataB);
        coasterStats['B'] = getCoasterStats(dataB);
        coasterStats['B'] = { ...getCoasterStats(dataB), name: dataB.name, id: dataB.id }; // Set name for coaster B

        // Update the variable to indicate that it's not the first press anymore
        isFirstPress = false;
        } else {
          // Set coasterA to coasterB json and visually move Coaster B's data to Coaster A
          moveCoasterData('B', 'A');
          coasterStats['A'] = coasterStats['B'];

          // Fetch new data for Coaster B
          do {
            dataB = await fetchRandomCoaster('B');
          } while (isCoasterInPreviousCoasters(dataB)); // Keep fetching until Coaster B is different from both Coaster A, the previous Coaster B, and not in the previousCoasters array

          displayCoasterInfo('B', dataB);
          coasterStats['B'] = getCoasterStats(dataB);
          coasterStats['B'] = { ...getCoasterStats(dataB), name: dataB.name, id: dataB.id }; // Set name for coaster B
        }

        // Add the current coaster B to the previousCoasters array
        previousCoasters.push(coasterStats['B'].id);

        // Keep only the last 5 coasters in the array
        if (previousCoasters.length > repeatLen) {
          previousCoasters = previousCoasters.slice(previousCoasters.length - repeatLen);
        }

        // Compare a random stat between the two coasters
        compareRandomStat(coasterStats['A'], coasterStats['B']);
  
      // Enable the button after a delay of 2 seconds
      setTimeout(() => {
        document.getElementById('randomCoasterButton').disabled = false;
      }, 1000);
    }

    // Check if a coaster is in the previousCoasters array
    function isCoasterInPreviousCoasters(coaster) {
      return previousCoasters.includes(coaster.id);
    }

    function getCoasterStats(coaster) {
      convertStats(coaster);
      return {
        length: lengthValue,
        height: heightValue,
        drop: dropValue,
        speed: speedValue,
        inversions: invertValue,
        verticalAngle: angleValue,
        duration: durationValue,
        capacity: capacityValue,
        cost: costValue,
        year: yearValue
      };
    }

    async function fetchRandomCoaster(coasterId) {
      randomVal = Math.floor(Math.random() * whitelist.length);
      randomID = whitelist[randomVal];
      // Make a request to the rcdb scraper for a random coaster
      const response = await fetch(`https://rcdb-api.vercel.app/api/coasters/${randomID}`);
      const data = await response.json();

      // If the coaster is not valid, retry fetching
      if (!isValidCoaster(data)) {
        return fetchRandomCoaster(coasterId);
      }

      return data;
    }

    function moveCoasterData(fromCoasterId, toCoasterId) {
      const fromCoasterInfo = document.getElementById(`coasterInfo${fromCoasterId}`);
      //const fromCoasterStats = document.getElementById(`coasterStats${fromCoasterId}`);
      const fromCoasterPic = document.getElementById(`coaster${fromCoasterId}`);
      const fromImageCredit = document.getElementById(`imageCredit${fromCoasterId}`);

      const toCoasterInfo = document.getElementById(`coasterInfo${toCoasterId}`);
      //const toCoasterStats = document.getElementById(`coasterStats${toCoasterId}`);
      const toCoasterPic = document.getElementById(`coaster${toCoasterId}`);
      const toImageCredit = document.getElementById(`imageCredit${toCoasterId}`);

      // Move data from 'fromCoaster' to 'toCoaster'
      toCoasterInfo.innerHTML = fromCoasterInfo.innerHTML;
      //toCoasterStats.innerHTML = fromCoasterStats.innerHTML;
      toCoasterPic.style.backgroundImage = fromCoasterPic.style.backgroundImage;
      toCoasterPic.style.backgroundSize = fromCoasterPic.style.backgroundSize;
      toCoasterPic.style.backgroundPosition = fromCoasterPic.style.backgroundPosition;
      toImageCredit.innerHTML = fromImageCredit.innerHTML;
    }

    async function displayCoasterInfo(coasterId, coaster) {
      const coasterInfoElement = document.getElementById(`coasterInfo${coasterId}`);
      //const coasterStatsElement = document.getElementById(`coasterStats${coasterId}`);
      const coasterPicElement = document.getElementById(`coaster${coasterId}`);
      const imageCreditElement = document.getElementById(`imageCredit${coasterId}`);

      convertStats(coaster);

      // Display coaster name, park name, and park location
      coasterInfoElement.innerHTML = `
          <div>Name: ${coaster.name}</div>
          <div>Park: ${coaster.park.name}</div>
          <div>Location: ${coaster.city}, ${coaster.state}, ${coaster.country}</div>`;

      // Set the background image for the coaster
      const imageUrl = displayImage(coasterId, coaster.mainPicture, coasterPicElement);
      coasterPicElement.style.backgroundImage = imageUrl ? `url('${imageUrl}')` : 'none';
      coasterPicElement.style.backgroundSize = 'cover';
      coasterPicElement.style.backgroundPosition = 'center';
      // Display image credit
      displayImageCredit(coasterId, coaster.mainPicture, imageCreditElement);

      // Display coaster stats (debug only)
/*      coasterStatsElement.innerHTML = `
            <div>Length: ${lengthValue}</div>
            <div>Height: ${heightValue}</div>
            <div>Drop: ${dropValue}</div>
            <div>Speed: ${speedValue}</div>
            <div>Inversions: ${invertValue}</div>
            <div>vertical Angle: ${angleValue}</div>
            <div>Duration: ${durationValue}</div>
            <div>Capacity: ${capacityValue}</div>
            <div>Cost: ${costValue}</div>
            <div>Opening Year: ${yearValue}</div>`;*/

      // Display full coaster data in the console
      console.log(`Full Coaster Data ${coasterId}:`, coaster);

      // Display image on the HTML page
      displayImage(coasterId, coaster.mainPicture, coasterPicElement);

      // Display image credit
      displayImageCredit(coasterId, coaster.mainPicture, imageCreditElement);
    }

    function displayImageCredit(coasterId, picture, imageCreditElement) {
          // Check if the image credit element exists before updating its text content
          if (imageCreditElement) {
            // Display image credit if available, otherwise show 'Unknown'
            const credit = picture.copyName ? `Photo by ${picture.copyName}` : 'Photo by Unknown';
            imageCreditElement.textContent = credit;
          }
        }

        function displayImage(coasterId, picture, coasterPicElement) {
          // Check if the image container element exists before updating its content
          if (coasterPicElement) {
            // Return the image URL if available
            return picture ? picture.url : '';
          }
          return ''; // Return an empty string if no image is available
        }

    function isValidCoaster(coaster) {
      // Check if the coaster has a picture and a valid name
      return coaster.mainPicture && coaster.mainPicture.url && coaster.name && coaster.name !== 'Unknown';
    }

    function convertStats(coaster) {
      lengthValue = coaster.stats && coaster.stats.length ? parseNumericValue(coaster.stats.length) || 'Unknown' : 'Unknown';
      heightValue = coaster.stats && coaster.stats.height ? parseNumericValue(coaster.stats.height) || 'Unknown' : 'Unknown';
      dropValue = coaster.stats && coaster.stats.drop ? parseNumericValue(coaster.stats.drop) || 'Unknown' : 'Unknown';
      speedValue = coaster.stats && coaster.stats.speed ? parseNumericValue(coaster.stats.speed) || 'Unknown' : 'Unknown';
      angleValue = coaster.stats && coaster.stats.verticalAngle ? parseNumericValue(coaster.stats.verticalAngle) || 'Unknown' : 'Unknown';
      invertValue = coaster.stats && coaster.stats.inversions != null ? (coaster.stats.inversions === 0 ? 0 : parseNumericValue(coaster.stats.inversions)) : 'Unknown';
      costValue = coaster.stats && coaster.stats.cost ? parseNumericValue(coaster.stats.cost) || 'Unknown' : 'Unknown';
      capacityValue = coaster.stats && coaster.stats.capacity ? parseNumericValue(coaster.stats.capacity) || 'Unknown' : 'Unknown';
      durationValue = coaster.stats && coaster.stats.duration ? convertDuration(coaster.stats.duration) : 'Unknown';
      yearValue = coaster.status && coaster.status.date ? convertYear(coaster.status.date) : 'Unknown';
    }

    function parseNumericValue(value) {
      if (typeof value === 'string') {
        const numericPart = value.replace(/[^\d.]/g, ''); // Remove non-number characters
        return numericPart !== '' ? parseFloat(numericPart) : NaN;
      } else {
        return NaN;
      }
    }

    function getRandomStat() {
      //                 0        1         2           3               4             5           6        7        8
      const stats = ['length', 'height', 'speed', 'inversions', 'verticalAngle', 'duration', 'capacity', 'cost', 'year'];
      let randomIndex = Math.floor(Math.random() * stats.length);
      randomStat = stats[randomIndex];

      // Check if both coasters have a value for the selected stat or if they are equal, if so reroll
      while (
        coasterStats['A'][randomStat] === 'Unknown' || // if either is unknown (no stat for that category)
        coasterStats['B'][randomStat] === 'Unknown' ||
        coasterStats['A'][randomStat] === coasterStats['B'][randomStat] || // or if the stats are equal
        ((randomStat == 'inversions') && ((coasterStats['A'][randomStat] === 0) || (coasterStats['B'][randomStat] === 0))) // or if there is a coaster with 0 inversions
      ) {
        randomIndex = Math.floor(Math.random() * stats.length);
        randomStat = stats[randomIndex];
      }

      return stats[randomIndex];
    }

    function compareRandomStat(coasterA, coasterB) {
      const randomStat = getRandomStat();
      let randomStatFixed = '';
      let statAOut = '';
      let statAAdd = '';

      const statA = coasterStats['A'][randomStat];
      const statB = coasterStats['B'][randomStat];

      // Display the random stat and values for both coasters on the screen
      if (randomStat == 'length') {randomStatFixed = 'Length'; if (statType == "m") { statAAdd = "meters"; statAOut = statA } else { statAAdd = "feet"; statAOut = (statA * 3.280839895).toFixed(1) }}
      else if (randomStat == 'height') {randomStatFixed = 'Height'; if (statType == "m") { statAAdd = "meters"; statAOut = statA } else { statAAdd = "feet"; statAOut = (statA * 3.280839895).toFixed(1) }}
      else if (randomStat == 'speed') {randomStatFixed = 'Speed'; if (statType == "m") { statAAdd = "km/h"; statAOut = statA } else { statAAdd = "mph"; statAOut = (statA * 0.621371).toFixed(1) }}
      else if (randomStat == 'inversions') {randomStatFixed = 'Inversion Count'; statAAdd = ""; statAOut = statA }
      else if (randomStat == 'verticalAngle') {randomStatFixed = 'Drop Angle'; statAAdd = "degrees"; statAOut = statA }
      else if (randomStat == 'duration') {randomStatFixed = 'Duration'; statAAdd = "seconds"; statAOut = statA }
      else if (randomStat == 'capacity') {randomStatFixed = 'Capacity'; statAAdd = "rph"; statAOut = statA }
      else if (randomStat == 'cost') {randomStatFixed = 'Cost'; statAAdd = "dollars"; statAOut = statA }
      else if (randomStat == 'year') {randomStatFixed = 'Opening Year'; statAAdd = ""; statAOut = statA }
      document.getElementById('randomStatDisplay').innerHTML = `${randomStatFixed}<p id="randomStatDeco">is</p>`;
      document.getElementById('randomStatDisplayA').innerHTML = `${randomStatFixed}<p id="randomStatDeco">is</p>`;
      document.getElementById('randomNameDisplay').innerHTML = `<p id="randomNameDeco">than ${coasterA.name}</p>`;
      
      document.getElementById('statValA').innerHTML = `<p id="leftStat">${statAOut}</p>`;
      document.getElementById('unitValA').innerHTML = `<p id="leftUnit">${statAAdd}</p>`;

      // Display the random stat and values for both coasters
      console.log(`Random Stat: ${randomStat}`);
      console.log(`${coasterA.name}'s ${randomStat}: ${statA}`);
      console.log(`${coasterB.name}'s ${randomStat}: ${statB}`);

      // Compare the stats
      if (!isNaN(statA) && !isNaN(statB)) {
        if (statA > statB) {
          console.log(`A: ${coasterStats['A'].name} has a higher ${randomStat}`);
          answer = 'lower';
        } else if (statA < statB) {
          console.log(`B: ${coasterStats['B'].name} has a higher ${randomStat}`);
          answer = 'higher';
        } else {
          console.log(`Both coasters have the same ${randomStat}`); // this should never happen lol
        }
      } else {
        console.log(`Cannot compare non-numeric stats for ${randomStat}`); // this should also never happen lol
      }
    }

      // Function to convert duration to remove the : for comparison later
      function convertDuration(duration) {
        const parts = duration.split(':');
        if (parts.length === 2) {
          const minutes = parseInt(parts[0], 10);
          const seconds = parseInt(parts[1], 10);
          return minutes * 60 + seconds;
        }
        return 'Unknown';
      }

      // Function to convert year to just year, remove - for comparison later
      function convertYear(dateString) {
        const yearPart = dateString.split('-')[0];
        return !isNaN(yearPart) ? parseInt(yearPart, 10) : 'Unknown';
      }

      function lowerInput() {
        if (answer == 'lower') {
          correct();
        } else {
          wrong();
        }
      }

      function higherInput() {
        if (answer == 'higher') {
          correct();
        } else {
          wrong();
        }
      }

      function correct() {
        console.log("WINNER!");
        getRandomCoasters()
      }

      function wrong() {
        console.log("L LOSER!");
        alert("L BOZO GET OWNED LLLLLLLLLL");
      }

      function toggleSettingsPanel() {
        var settingsPanel = document.getElementById('settingsPanel');
        if (settingsPanel.style.display === 'none') {
            settingsPanel.style.display = 'block';
        } else {
            settingsPanel.style.display = 'none';
        }
      }

        function closeSettingsPanel() {
          document.getElementById('settingsPanel').style.display = 'none';
        }

    </script>
  </body>
</html>
